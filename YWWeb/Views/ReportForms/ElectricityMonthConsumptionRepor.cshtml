@{
    Layout = null;
}
<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>月用电量分析</title>
    @Html.Partial("~/Views/Home/BaseHTML.cshtml")
    <script src="~/Content/TreeTable/jquery.treeTable.js" type="text/javascript"></script>
    <script src="~/Content/UserJS/CommonUnit._jm.js"></script>
    <link rel="stylesheet" type="text/css" href="~/Content/iview/dist/styles/iview.css?v=1.01">
    <link href="~/Content/TreeTable/css/jquery.treeTable.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" type="text/css" href="~/Content/iview/dist/styles/iview.css?v=1.01">
    <style>
        #pzhtml td {
            text-align: center;
        }

        #monthReport {
            padding: 15px;
            padding-bottom: 50px
        }

        .reportTable {
            width: 100%;
            margin-top: 50px
        }

            .reportTable td {
                padding: 0 !important
            }

                .reportTable td .item-div {
                    border-right: 1px solid #000;
                    display: flex;
                    flex-direction: row;
                    justify-content: center;
                    align-items: center;
                    border-bottom: 1px solid #000;
                }

                .reportTable td .outItem-div:last-child .item-div {
                    border-bottom: 0px
                }

                .reportTable td .item-div:last-child {
                    border-right: 0px
                }

                

            .reportTable .title {
                font-size: 20px;
                font-weight: bold;
                padding: 10px 0px !important;
            }

            .reportTable .littleTitle {
                font-size: 16px;
                font-weight: bold;
                padding: 5px 10px !important;
            }

        .searchbutton .btn {
            border: none;
            color: #fff;
            background: #62b9a0;
            margin-top: 2px;
            border-radius: 2px;
            margin-right: 5px
        }

        .table2 tr td {
            border: 1px solid #000;
            border-right: 0px
        }

            .table2 tr td:first-child {
                border-left: 0px;
            }

            .table2 tr td:last-child {
                border-bottom: 0px;
            }

        .table2 tr:last-child td {
            border-bottom: 0
        }

        .table2 tr:first-child td {
            border-top: 0
        }
       
    </style>
</head>
<body>

    <div id="monthReport">

        <Spin size="large" fix v-if="loading"></Spin>

        <div id="tb" class="searchbar" style="overflow:visible;">

            <div class="searchrow">
                站室:
                <i-select style="width:180px" v-model="PID" v-on:on-change="stationChange"  :label-in-value="true">
                    <i-option v-for="item in stationList" :value="item.PID">{{item.Name}}</i-option>
                </i-select>
            </div>
            <div class="searchrow">
                月份:
                <date-picker type="month" style="width: 180px" v-model="dateTime" :clearable="false" v-on:on-change="dateChange"></date-picker>
            </div>
            <div class="searchrow">
                用户类型:

                <i-select style="width:180px" v-model="userType">
                    <i-option v-for="item in userTypeList" :value="item.id">{{item.name}}</i-option>
                </i-select>
            </div>

            <div id="" class="searchbutton">
                <i-button v-for="item in userBtn" class="btn" v-on:click="userMenuClick(item.Location)"><img v-bind:src="item.src" />{{item.ModuleName}}</i-button>
                <i-button class="btn" v-on:click="openOrPrint" icon="ios-print-outline">打印</i-button>
                <i-button class="btn" v-on:click="ExcelPort" icon="md-exit">导出</i-button>
            </div>

        </div>
        <table cellpadding="" cellspacing="" border="1" class="d_list" style="margin-top:20px; font-size:14px;" id="pzhtml">
            @*<caption style="font-weight:bold;" id="CTitle"></caption>*@
            <thead>
                <tr id="header" style='background-color:#F5F5F7'>
                    @*<th>序号</th>

                    <th>日期</th>

                    <th>1号</th>

                    <th>2号</th>*@
                </tr>
            </thead>
            <tbody id="content" style="background-color:#FFFFFF">
                <tr>
                    @*<td>品种1</td>
                    <td>品种1</td>
                    <td>品种1</td>
                    <td>品种1</td>*@
                    @*<td>品种1</td>
                    <td>品种1</td>*@
                </tr>

            </tbody>

            <tfoot id="fotter" style='font-weight:bold;background-color:#FFFFFF'>
                @*<tr>

                <td></td>
                <td></td>
                </tr>
                <tr>
                <td></td>
                <td>最大值</td>
                <td></td>
                <td></td>
                </tr>*@
            </tfoot>
        </table>

        <table border="" cellspacing="0" cellpadding="0" class="reportTable">
            <tr>
                <td :colspan="days.length+2" align="center" class="title">{{curTimeStr}} 月配电室能源统计表 (kW·h)</td>
            </tr>
            <tr>
                <td :colspan="days.length+2" class="littleTitle">&nbsp;{{cruPname}}</td>
            </tr>
            <tr>
                <td colspan="1" style="width:50px">&nbsp;</td>
                <td :colspan="days.length+1">
                    <div style="width:100%;display:flex;flex-direction:row" class="outItem-div">
                        <div style="flex:1" class="item-div"></div>
                        <div style="flex:1" class="item-div" v-for="item in days">
                            {{item}}
                        </div>
                    </div>
                </td>

            </tr>
            <tr v-for='item in info'>
                <td align="center" style="width:50px">
                    {{item.DeviceName}}

                </td>
                <td :colspan="days.length+1">
                    <div style="width:100%;display:flex;flex-direction:row" class="outItem-div" v-for="data in item.list_data">
                        <div style="flex:1;word-wrap:break-word;word-break: break-all;overflow:hidden" class="item-div" :title="data.Cname">
                            {{data.Cname==""?'--':data.Cname}}
                        </div>
                        <div style="flex:1;overflow:hidden" class="item-div" v-for="val in data.Value">
                            <div class="item-div" style="word-wrap:break-word;word-break: break-all;overflow:hidden;border-bottom:0px">
                                {{val |toFixed}}
                            </div>
                        </div>
                    </div>

                </td>
            </tr>

        </table>


    </div>

</body>
</html>

<script type="text/javascript">
    /*var type = 2;
    ////获取url中的参数
    function getUrlParam(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象
        var r = window.location.search.substr(1).match(reg);  //匹配目标参数
        if (r != null) return unescape(r[2]); return null; //返回参数值
    }
    var flag = getUrlParam("isHide");
    if (flag == 1) {
        $("#tb").hide()
    } else {
        $("#tb").show();
    }

    $.ajaxSettings.async = false;
    $('#Time').datebox({
        onShowPanel: function () {// 显示日趋选择对象后再触发弹出月份层的事件，初始化时没有生成月份层
            span.trigger('click'); // 触发click事件弹出月份层
            if (!tds)
                setTimeout(function () {// 延时触发获取月份对象，因为上面的事件触发和对象生成有时间间隔
                    tds = p.find('div.calendar-menu-month-inner td');
                    tds.click(function (e) {
                        e.stopPropagation(); // 禁止冒泡执行easyui给月份绑定的事件
                        var year = /\d{4}/.exec(span.html())[0]// 得到年份
                            , month = parseInt($(this).attr('abbr'), 10) + 1; // 月份
                        $('#Time').datebox('hidePanel')// 隐藏日期对象
                            .datebox('setValue', year + '-' + month); // 设置日期的值
                    });
                }, 0);
        },
        parser: function (s) {// 配置parser，返回选择的日期
            if (!s)
                return new Date();
            var arr = s.split('-');
            return new Date(parseInt(arr[0], 10), parseInt(arr[1], 10) - 1, 1);
        },
        formatter: function (d) {
            var month = d.getMonth();
            if (month < 10) {
                month = "0" + month;
            }
            if (d.getMonth() == 0) {
                return d.getFullYear() - 1 + '-' + 12;
            } else {
                return d.getFullYear() + '-' + month;
            }
        }// 配置formatter，只返回年月

    });
    var p = $('#Time').datebox('panel'), // 日期选择对象
        tds = false, // 日期选择对象中月份
        span = p.find('span.calendar-text'); // 显示月份层的触发控件

    $("#SPID").combobox({
        url: "/BaseInfo/BindPDRInfo?showall=0",
        valueField: 'PID',
        textField: 'Name',
        editable: true,
        onLoadSuccess: function () { //数据加载完毕事件
            var data = $('#SPID').combobox('getData');
            //alert(1);
            //console.log(data);
            if ($.cookie('cookiepid') > 0) {
                $("#SPID").combobox('select', $.cookie('cookiepid'));
                return
            }
            else if (data.length > 0) {
                $("#SPID").combobox('select', data[0].PID);
            }
        }, onSelect: function (v) {
            $.cookie('cookiepid', v.PID, { expires: 7, path: '/' });
            dosearch();
        }
    });
    function dosearch() {
        var t = getUrlParam("Time");
        if (t != null && t != "") {
            var dd = new Date(t);
            var ddd = dd.getFullYear() + "-" + (dd.getMonth() + 2);
            $('#Time').datebox("setValue", ddd);
        }
        if ($("#Time").datebox("getValue") == "" || $("#Time").datebox("getValue") == null) {
            $('#Time').datebox("setValue", getNowFormatDate());
        }
        $.post("/ReportForms/getPowerQualityData", { "pid": $('#SPID').combobox("getValue"), "Time": $('#Time').datebox("getValue"), "type": type }, function (data) {
            $("#header").empty();
            $("#content").empty();
            $("#fotter").empty();
            var str = "";
            if ($("#Time").datebox("getValue") != "") {
                str = $("#Time").datebox("getValue") + "月用电量数据分析";
            }
            $("#CTitle").html(str)
            var Hhtml = "<th style='background-color:#fafafa'>日期</th>";
            $.each(data.Cname, function (index, val) {
                Hhtml += " <th>" + val.CID + "号回路" + val.CName + "</th>";
            })
            Hhtml += " <th>合计</th>"
            $("#header").html(Hhtml);
            var html = "";
            var inn = 1;

            $.each(data.Rtime, function (index, val) {
                var summ = 0;
                var itt = 1;
                html += "<tr>";
                //html += "<td>" + (index + 1) + "</td>"
                html += "<td>" + (DateFormat(val)) + "</td>"
                $.each(data.list[index], function (inde, va) {
                    summ += va.Aphase;
                    html += "<td>" + va.Aphase + "</td>"
                    itt++;
                })
                for (itt; itt <= data.Cname.length; itt++) {
                    html += "<td>0</td>"
                }
                html += "<td>" + summ.toFixed(2) + "</td>";
                html += "</tr>"
            })
            $("#content").html(html);
            var fhtml = "<tr><td>最大值</td>";
            for (var index = 0; index < data.Cname.length + 1; index++) {
                fhtml += " <td>" + (getMaxValue(1, index + 1)) + "</td>";
            }
            fhtml += "</tr>"
            var summmm = 0;
            fhtml += "<tr><td>小计</td>";
            for (var index = 0; index < data.Cname.length + 1; index++) {
                summmm += parseFloat((getTdValue(1, index + 1)));
                fhtml += " <td>" + (getTdValue(1, index + 1)) + "</td>";
            }
            fhtml += "</tr>"
            $("#fotter").html(fhtml);
        });
    }

    function DateFormat(value, row, index) {
        var lDate = formatDate(value, 'MM-dd');
        return lDate;
    }

    function getTdValue(ii, x) {
        var tableId = document.getElementById("pzhtml");
        var str = 0;
        //alert(tableId.rows[1].cells[2].innerHTML);
        for (var i = ii; i < tableId.rows.length; i++) {

            str += parseFloat(tableId.rows[i].cells[x].innerHTML);


        }
        return str.toFixed(2);
    }
    function getMaxValue(ii, x) {
        var tableId = document.getElementById("pzhtml");
        //alert(tableId.rows[1].cells[2].innerHTML);
        var obj = [];
        for (var i = ii; i < tableId.rows.length; i++) {

            obj.push(parseFloat(tableId.rows[i].cells[x].innerHTML));
        }
        var max = Math.max.apply(obj, obj);
        return max;
    }
    function openOrPrint() {
        window.open('/ReportForms/ElectricityMonthConsumptionRepor?pid=' + $('#SPID').combobox("getValue") + "&Time=" + $('#Time').datebox("getValue") + "&isHide=1", '_blank');
        window.print()
    }
    function ExcelPort() {
        window.open('/ReportForms/ExportData?pid=' + $('#SPID').combobox("getValue") + "&Time=" + $('#Time').datebox("getValue") + "&isHide=1" + "&type=" + type, '_blank');
        //window.print()
    }


    function getNowFormatDate() {
        var date = new Date();
        var seperator1 = "-";
        var year = date.getFullYear();
        var month = date.getMonth() + 2;
        var strDate = date.getDate();
        if (month >= 1 && month <= 9) {
            month = "0" + month;
        }
        if (strDate >= 0 && strDate <= 9) {
            strDate = "0" + strDate;
        }
        var currentdate = year + seperator1 + month + seperator1 + strDate;
        return currentdate;
    }*/
</script>


<script src="~/Content/js/echarts.min.js" type="text/javascript"></script>
<script type="text/javascript" src="~/Content/js/jquery.cookie.js"></script>
<script type="text/javascript" src="~/Content/js/vue.min.js"></script>
<script type="text/javascript" src="~/Content/js/vue-resource.min.js"></script>
<script type="text/javascript" src="~/Content/iview/dist/iview.js"></script>
<script type="text/javascript" src="~/Content/UserJS/ElectricityMonthConsumptionRepor._zc.js?v=1.02"></script>